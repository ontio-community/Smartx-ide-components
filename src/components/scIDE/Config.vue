<style scoped>
.deploy-page{
    margin-left: 5px ;
    margin-right: 5px;
    height: 100%;
  }
  .deploy-btn-submit {
    border-radius: 0;
    width: 100%;
    color: white;
    border-color: #36a3bc;
    background-color: #36a3bc;
    font-size: 10px;
    padding: 8px 17.6px;
  }
  .deploy-btn-submit:hover,
  .deploy-btn-submit:active {
    background-color: #36a3bc;
    color: white;
  }
  .deploy-card{
    margin-top: 5px;
  }
  .card{
    max-width: 100% !important;
    height: 100% !important;
    border-radius:0;
  }
  .card-header{
    background-color: white;
    text-align: center;
    color: #36a3bc;
    padding-top: 6px !important;
    padding-bottom: 6px !important;
  }
  .card-body {
    padding-top: 15px !important;
    padding-bottom: 0 !important;
  }
  .card-last-body {
    padding-bottom: 15px !important;
  }
  .card-text{
    margin-bottom: 2px;
  }
  .card-text-center{
    text-align: center;
  }
  .card-fee{
    height: 45%;
  }
  .card-result{
    height: 30%;
    margin-bottom: -26px;
    padding-bottom: 26px;
  }

  .deploy-info-card-text {
    width: 70px;
    text-align: right;
  }

  .deploy-input{
    width: 70%;
    border-radius:0px;
  }
  .border-secondary{
    border-color: #C4C3C3 !important;
  }

  .deploy-dialog-btn-close{
    border-radius:0px;
  }
  .deploy-card-scroll{
    overflow-y:auto;
  }
  .devlop-modal{
    margin-top: 10%;
  }
  .error-modal-body-text{
    font-size: 16px;
  }

  .deploy-page{
    margin-left: 5px ;
    margin-right: 5px;
    height: 100%;
  }
  .deploy-card{
    margin-top: 5px;
  }
  .card{
    max-width: 100% !important;
    height: 100% !important;
    border-radius:0;
  }
  .card-header{
    background-color: white;
    text-align: center;
    color: #36a3bc;
    padding-top: 6px !important;
    padding-bottom: 6px !important;
  }
  .card-body {
    padding-top: 15px !important;
    padding-bottom: 0 !important;
  }
  .card-last-body {
    padding-bottom: 15px !important;
  }
  .card-text{
    margin-bottom: 2px;
  }
  .card-text-center{
    text-align: center;
  }

  .card-info{
    height: 35%;
    margin-top: -65px;
    padding-top: 69px;
  }
  .card-fee{
    height: 45%;
  }
  .card-result{
    height: 20%;
    margin-bottom: -26px;
    padding-bottom: 26px;
  }

  .deploy-info-card-text {
    width: 70px;
    text-align: right;
  }

  .deploy-input{
    width: 70%;
    border-radius:0px;
  }

  .deploy-page{
    margin-left: 5px ;
    margin-right: 5px;
    height: 100%;
  }
  .deploy-btn-submit {
    border-radius: 0;
    width: 100%;
    color: white;
    border-color: #36a3bc;
    background-color: #36a3bc;
  }
  .deploy-btn-submit:hover,
  .deploy-btn-submit:active {
    background-color: #36a3bc;
    color: white;
  }
  .deploy-card{
    margin-top: 5px;
  }
  .card{
    max-width: 100% !important;
    height: 100% !important;
    border-radius:0;
  }
  .card-header{
    background-color: white;
    text-align: center;
    color: #36a3bc;
    padding-top: 6px !important;
    padding-bottom: 6px !important;
  }
  .card-body {
    padding-top: 15px !important;
    padding-bottom: 15px !important;
  }
  .card-last-body {
    padding-bottom: 15px !important;
  }
  .card-text{
    margin-bottom: 2px;
  }
  .card-text-center{
    text-align: center;
  }

  .card-info{
    height: 35%;
    margin-top: -65px;
    padding-top: 69px;
  }
  .card-fee{
    height: 45%;
  }
  .card-result{
    height: 20%;
    margin-bottom: -26px;
    padding-bottom: 26px;
  }

  .deploy-info-card-text {
    width: 70px;
    text-align: right;
  }

  .deploy-input{
    width: 70%;
    border-radius:0px;
  }

  .deploy-custom-file-input {
    width: 100%;
  }
  .deploy-custom-file-label {
    position: absolute;
    top: 0;
    right: 0;
    left: 0;
    height: 36px;
    padding: .5rem 1.1rem;
    line-height: 1.5;
    color: #495057;
    background-color: #fff;
    border: 1px solid #ced4da;
    border-left: 1px solid #BCBEC1;
    margin-bottom: 0px;
  }
  .deploy-custom-file-label::after {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    display: block;
    padding: .5rem .75rem;
    color: #495057;
    content: "Browse";
    background-color: #e9ecef;
    border-left: 1px solid #BCBEC1;
    min-width: 55px;
    text-align: center;
  }
  .deploy-custom-zh-text-file-label {
    position: absolute;
    top: 0;
    right: 0;
    left: 0;
    height: 36px;
    padding: .5rem 1.1rem;
    line-height: 1.5;
    color: #495057;
    background-color: #fff;
    border: 1px solid #ced4da;
    border-left: 1px solid #BCBEC1;
    margin-bottom: 0px;
  }
  .deploy-custom-zh-text-file-label::after {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    display: block;
    padding: .5rem .75rem;
    color: #495057;
    content: "浏览";
    background-color: #e9ecef;
    border-left: 1px solid #BCBEC1;
    min-width: 55px;
    text-align: center;
  }
  .deploy-dialog-btn{
    background-color: #36a3bc;
    border-radius:0px;
  }
  .deploy-err-message {
    color: #ff0264 !important;
  }
  .input-group-text{
    border-radius:0px;
  }
  .devlop-custom-file{
    height: 36px;
  }
  .deploy-input-group-append{
    min-width: 55px;
  }
  .deploy-btn-submit-wallet{
    width: 49%;
    display: inline-block;
  }
  .link-applyOng {
      float: right;
      font-size:14px;
  }
</style>
<template>
    <div class="config-page">
       
            <div class="deploy-card card-info" >
            <div class="card border-secondary mb-3" style="max-width: 20rem;">
                <div class="card-header">{{$t('deploy.networkInfo')}}</div>
                <div class="deploy-card-scroll">
                <div class="card-body">
                    <p class="card-text test-title-text test-card-text-title" style="margin-top: 0px"><strong>{{ $t('test.selectNet') }}</strong></p>
                    <label class="card-text test-title-text"><input name="deployNet" type="radio" :checked="network === 'MAIN_NET' " @change="changeNetwork('MAIN_NET')"/><strong style="margin-left: 4px">{{ $t('test.mainNet') }}</strong></label>
                    <label class="card-text test-title-text" style="margin-left: 8px"><input name="deployNet" type="radio" :checked="network === 'TEST_NET' "  @change="changeNetwork('TEST_NET')"/><strong style="margin-left: 4px">{{ $t('test.testNet') }}</strong></label>
                    <label class="card-text test-title-text" style="margin-left: 8px"><input name="deployNet" type="radio" :checked="network === 'PRIVATE_NET' "  @change="changeNetwork('PRIVATE_NET', privateNet)"/><strong style="margin-left: 4px">{{ $t('test.privateNet') }}</strong></label>
                    <input class="test-private-net-input" v-show="network === 'PRIVATE_NET'&& !isHidePrivateNetInput" v-model="privateNet" >
                    <button v-show="network === 'PRIVATE_NET' " @click="changeNetwork('PRIVATE_NET', privateNet)" >ok</button>
                    <a v-show="network === 'PRIVATE_NET' && isHidePrivateNetInput">{{privateNet}}</a>
                </div>
                </div>
            </div>
        </div>
        <div class="deploy-card">
            <button class="btn btn-outline-success deploy-btn-submit deploy-btn-submit-wallet" data-toggle="modal" data-target="#WalletFileInfoInDeploy">{{$t('deploy.selectWallet')}}</button>
            <button class="btn btn-outline-success deploy-btn-submit deploy-btn-submit-wallet" style="float: right" data-toggle="modal" data-target="#GenerateWallet">{{$t('deploy.generateWallet')}}</button>
            </div>
            <div class="deploy-card card-info" >
            <div class="card border-secondary mb-3" style="max-width: 20rem;">
                <div class="card-header">{{$t('deploy.walletInfo')}}</div>
                <div class="deploy-card-scroll">
                
                <div  class="card-body">
                    <span class="card-text"><strong>{{ $t('deploy.address') }}</strong></span>
                    <span class="card-text">{{ wallet.address }}</span>
                </div>
                <div  class="card-body">
                    <span class="card-text"><strong>ONT:</strong></span>
                    <span class="card-text">{{ balance.ont}} </span>
                </div>
                <div  class="card-body card-last-body">
                    <span class="card-text"><strong>ONG:</strong></span>
                    <span class="card-text">{{ balance.ong}}</span>

                    <a  class="link-applyOng"  href="https://developer.ont.io/applyOng" target="_blank">{{$t('config.applyOng')}} <a-icon type="arrow-right" /></a>
                </div>
                </div>
            </div>
        </div>

         <!--Wallet Modal -->
    <div class="modal fade devlop-modal" id="WalletFileInfoInDeploy" tabindex="-1" role="dialog" >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">{{$t('deploy.selectWallet')}}</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <div class="custom-file devlop-custom-file">
                <input type="file" @change="onFileChange" class="deploy-custom-file-input" id="exampleInputFileInDeploy" aria-describedby="fileHelp"
                       name="file" v-validate data-vv-rules="required">
                <label id="deploy-input-file-label" class="deploy-custom-file-label" for="exampleInputFileInDeploy" >{{FileName}}</label>
              </div>
              <small class="form-text text-muted deploy-err-message" v-show="errors.has('file')">{{ errors.first('file') }}</small>
            </div>
            <div class="form-group">
              <div class="input-group">
                <input :type="[isShowPassword ? 'text' : 'password']"
                       v-model="password"
                       v-validate data-vv-rules="required|min:6"
                       class="form-control deploy-input" name="password" :placeholder="$t('deploy.enterPw')">
                <div class="input-group-append deploy-input-group-append" @click="viewPassword">
                    <span class="input-group-text">
                      <i class="fa" :class="[isShowPassword ? 'fa-eye' : 'fa-eye-slash']" aria-hidden="true"></i>
                    </span>
                </div>
              </div>
              <small class="form-text text-muted deploy-err-message" v-show="errors.has('password')">{{ errors.first('password') }}</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary deploy-dialog-btn-close" data-dismiss="modal">{{$t('deploy.close')}}</button>
            <button type="button" class="btn btn-primary deploy-dialog-btn" v-bind:disabled="waitingUnlockWallet" :data-dismiss="[closeDialog ? 'modal' : '']" @click="unlockWalletFile">{{waitingUnlockWallet ? $t('deploy.waitingUnlock') : $t('deploy.unlock')}}</button>
          </div>
        </div>
      </div>
    </div>

    <!--Enter Wallet Password Modal -->
    <div class="modal fade devlop-modal" id="enterWalletPassword" tabindex="-1" role="dialog" >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" >{{$t('deploy.selectWallet')}}</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <div class="input-group">
                <input :type="[isShowPassword ? 'text' : 'password']"
                       v-model="getWalletPrivateKeyPassowrd"
                       class="form-control deploy-input" name="password" :placeholder="$t('deploy.enterPw')">
                <div class="input-group-append deploy-input-group-append" @click="viewPassword">
                    <span class="input-group-text">
                      <i class="fa" :class="[isShowPassword ? 'fa-eye' : 'fa-eye-slash']" aria-hidden="true"></i>
                    </span>
                </div>
              </div>
              <small class="form-text text-muted deploy-err-message" v-show="errors.has('password')">{{ errors.first('password') }}</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary deploy-dialog-btn-close" data-dismiss="modal">{{$t('deploy.close')}}</button>
            <button type="button" class="btn btn-primary deploy-dialog-btn" v-bind:disabled="waitingUnlockWallet" :data-dismiss="[closeDialog ? 'modal' : '']" @click="getWalletPrivateKey">{{waitingUnlockWallet ? $t('deploy.waitingUnlock') : $t('deploy.unlock')}}</button>
          </div>
        </div>
      </div>
    </div>

    <!--Generate Wallet -->
    <div class="modal fade devlop-modal" id="GenerateWallet" tabindex="-1" role="dialog" >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" >{{$t('deploy.generateWallet')}}</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <div class="input-group">
                <input :type="[isShowPassword ? 'text' : 'password']"
                       v-model="generateWalletPassword"
                       class="form-control deploy-input" name="password" :placeholder="$t('deploy.enterPw')">
                <div class="input-group-append deploy-input-group-append" @click="viewPassword">
                    <span class="input-group-text">
                      <i class="fa" :class="[isShowPassword ? 'fa-eye' : 'fa-eye-slash']" aria-hidden="true"></i>
                    </span>
                </div>
              </div>
              <small class="form-text text-muted deploy-err-message" v-show="errors.has('password')">{{ errors.first('password') }}</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary deploy-dialog-btn-close" data-dismiss="modal">{{$t('deploy.close')}}</button>
            <button type="button" class="btn btn-primary deploy-dialog-btn" v-bind:disabled="waitingUnlockWallet" :data-dismiss="[closeDialog ? 'modal' : '']" @click="generateWallet">{{waitingUnlockWallet ? $t('deploy.waitingGenerate') : $t('deploy.generate')}}</button>
          </div>
        </div>
      </div>
    </div>

    </div>

</template>
<script>
import {mapState} from 'vuex'
import zh from './../../common/lang/zh'
import en from './../../common/lang/en'
import LangStorage from './../../helpers/lang'
import Sleep from './../../helpers/sleep'
import FileHelper from './../../common/ont-wallet/file-generate-and-get'
import OWallet from './../../common/ont-wallet/wallet'
let Ont = require('ontology-ts-sdk');
export default {
  name: "Config",
  data() {
      return {
          privateNet: '',
          isHidePrivateNetInput: false,
          waitingStatus: false,
        ErrorInfo: '',
        showWalletInfo: false,
        password: '',
        isShowPassword: false,
        FileName: '',
        WalletFile: '',
        closeDialog : false,
        waitingUnlockWallet: false,
        privateNet:'http://127.0.0.1',
        getWalletPrivateKeyPassowrd:'',
        generateWalletPassword:''
      }
  },
  computed: {
      ...mapState({
          network: state => state.Config.network,
          wallet: state => state.Config.wallet,
          balance: state => state.Config.wallet.balance
      })
  },
  mounted() {
      this.$store.dispatch('updateConfigBalance')
      this.interval = setInterval(()=>{
        this.$store.dispatch('updateConfigBalance')
      }, 5000)
  },
  beforeDestroy() {
    clearInterval(this.interval)
  },
  methods: {
      changeNetwork(network, url) {
          if(network === 'PRIVATE_NET') {
              if(!url) {
                  alert('Please enter the url of your private net');
                  return;
              }
          }
          this.$store.dispatch('changeNetWork', {network, url})
      },
      privateNetInputState() {

      },
      viewPassword() {
        this.isShowPassword = !this.isShowPassword
      },
      onFileChange() {
        let files = document.getElementById("exampleInputFileInDeploy").files
        if (!files.length){
          this.FileName = (LangStorage.getLang('zh') === "zh") ? zh.login.chooseFile : en.login.chooseFile
          return
        }
        this.FileName = files[0].name
        this.WalletFile = files[0]
      },
      unlockWalletFile(){
        let _self = this
        this.$validator.validateAll().then(result => {
          if (result) {
            this.waitingUnlockWallet = true
            Sleep.sleep(200).then(() => {
              FileHelper.readWalletFile(this.WalletFile).then((walletFile) => {
                if(walletFile) {
                  let account = OWallet.decryptWalletFile(JSON.parse(walletFile), this.password)
                  if(account ) {
                    _self.getNetworkWalletInfo(account,_self)
                    _self.showWalletInfo = true
                    $("#WalletFileInfoInDeploy").modal("hide");
                  }else{
                    let title = (LangStorage.getLang('zh') === "zh") ? zh.deploy.errorTitle : en.deploy.errorTitle
                    let content = (LangStorage.getLang('zh') === "zh") ? zh.deploy.errowWalletPassword : en.deploy.errowWalletPassword
                    this.showErrorModel(title,content,true)
                    $("#WalletFileInfoInDeploy").modal("hide");
                  }
                }else{
                }
              })
              this.waitingUnlockWallet = false
            })
          }else{
          }
        })
      },
      getNetworkWalletInfo($account,_self){
        _self.$store.commit('UPDATE_CONFIG_ADDRESS', {address: $account.address})
        _self.$store.commit('UPDATE_CONFIG_PRIKEY', { privateKey: $account.privateKey.key})
        _self.$store.dispatch('updateConfigBalance')
      },
      showEnterWalletPassword(){
        if(this.deployWalletInfo.info) {
          $("#enterWalletPassword").modal("show");
        }else{
          let title = (LangStorage.getLang('zh') === "zh") ? zh.deploy.errorTitle : en.deploy.errorTitle
          let content = (LangStorage.getLang('zh') === "zh") ? zh.deploy.errorWallet : en.deploy.errorWallet
          this.showErrorModel(title,content,true)
        }
      },
      getWalletPrivateKey(){
        this.waitingUnlockWallet = true
        let account = this.deployWalletInfo.info.account
        let privateKey = OWallet.getAccountPrivateKey(account,this.getWalletPrivateKeyPassowrd)

        if(privateKey){
          this.waitingUnlockWallet = false
          $("#enterWalletPassword").modal("hide");
          this.doDeploy(privateKey)
        }else{
          this.waitingUnlockWallet = false
          let title = (LangStorage.getLang('zh') === "zh") ? zh.deploy.errorTitle : en.deploy.errorTitle
          let content = (LangStorage.getLang('zh') === "zh") ? zh.deploy.errowWalletPassword : en.deploy.errowWalletPassword
          this.showErrorModel(title,content,true)
          $("#enterWalletPassword").modal("hide");
        }

      },
      generateWallet(){
        let privateKey = Ont.Crypto.PrivateKey.random()
        const wif = privateKey.serializeWIF();
        let body = {
          label: this.label,
          privateKey: privateKey,
          password: this.generateWalletPassword,
          wif: wif
        }
        let account = OWallet.createJsonWalletWithPrivateKey(body)
        $("#GenerateWallet").modal("hide");

      },
  }
};
</script>
